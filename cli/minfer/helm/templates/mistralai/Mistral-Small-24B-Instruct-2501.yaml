# Description: Template for Mistral Small 24B Instruct 2501 model deployment with vLLM backend
apiVersion: registry.matrixinfer.ai/v1alpha1
kind: Model
metadata:
  annotations:
    api.kubernetes.io/name: {{ .Values.annotationName | default "example" | quote }}
  name: {{ .Values.name | default "mistral-small-24b-instruct-2501" | quote }}
  {{- if .Values.namespace }}
  namespace: {{ .Values.namespace | quote }}
  {{- end }}
spec:
  name: {{ .Values.modelName | default .Values.name | default "mistral-small-24b-instruct-2501" | quote }}
  owner: {{ .Values.owner | default "example" | quote }}
  autoscalingPolicy:
    metrics:
      - metricName: {{ .Values.metricName | default "matrixinfer:num_requests_waiting" | quote }}
        targetValue: {{ .Values.targetValue | default 10 }}
  backends:
    - name: {{ .Values.backendName | default "mistral-small-24b-instruct-2501-vllm" | quote }}
      type: {{ .Values.backendType | default "vLLM" | quote }}
      modelURI: {{ .Values.modelURI | default "s3://model-bucket/mistral-small-24b-instruct-2501" | quote }}
      cacheURI: {{ .Values.cacheURI | default "hostpath://tmp/test" | quote }}
      minReplicas: {{ .Values.minReplicas | default 1 }}
      maxReplicas: {{ .Values.maxReplicas | default 3 }}
      scalingCost: {{ .Values.scalingCost | default 1 }}
      scaleToZeroGracePeriod: {{ .Values.scaleToZeroGracePeriod | default "60s" | quote }}
      workers:
        - type: {{ .Values.workerType | default "server" | quote }}
          image: {{ .Values.workerImage | default "vllm/vllm-openai:v0.7.1" | quote }}
          replicas: {{ .Values.workerReplicas | default 0 }}
          pods: {{ .Values.workerPods | default 0 }}
          config:
            maxModelLen: {{ .Values.maxModelLen | default 32768 }}
          resources:
            limits:
              nvidia.com/gpu: {{ .Values.gpuLimit | default "2" | quote }}
            requests:
              nvidia.com/gpu: {{ .Values.gpuRequest | default "2" | quote }}
      {{- if .Values.loraAdapters }}
      loraAdapters:
        {{- range .Values.loraAdapters }}
        - name: {{ .name | quote }}
          artifactURL: {{ .artifactURL | quote }}
        {{- end }}
      {{- end }}